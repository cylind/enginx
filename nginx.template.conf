# 全局配置
# user 指令在 http 块中设置，worker_processes 由官方 entrypoint 自动调整
# pid 路径和 error_log/access_log 路径均使用官方镜像默认值
# 官方镜像已将默认日志路径链接到 /dev/stdout 和 /dev/stderr

# 事件模块
events {
    worker_connections 1024;
}

# HTTP 模块
http {
    # 使用官方镜像已链接到 /dev/stdout 的默认日志路径
    access_log /var/log/nginx/access.log;
    # 使用官方镜像已链接到 /dev/stderr 的默认错误日志路径
    error_log /var/log/nginx/error.log;
    # 禁止在错误页面中显示 Nginx 版本号
    server_tokens off;

    # 包含 MIME 类型定义
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 您的原始 server 配置
    server {
        listen ${PORT} default_server;
        listen [::]:${PORT} default_server;

        location / {
            root   /app/html;
            index  index.html;
            try_files $uri $uri/ /index.html;
        }

        location ${WSPATH} {
            if ($http_upgrade != "websocket") {
                return 404;
            }
            proxy_pass http://127.0.0.1:9008;
            proxy_redirect off;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
        }

        location /healthz {
            return 200 "OK";
        }
    }
}